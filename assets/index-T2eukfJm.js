(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=e(o);fetch(o.href,r)}})();class ie{constructor(t,...e){var s,o;this.currentState=t,(o=(s=this.currentState).onEnter)==null||o.call(s,...e)}setState(t,...e){var s,o,r,l;(o=(s=this.currentState).onLeave)==null||o.call(s),this.currentState=t,(l=(r=this.currentState).onEnter)==null||l.call(r,...e)}getState(){return this.currentState}}let M;function oe(i,...t){M=new ie(i,...t)}const Zt=i=>i.replace(/^#?([a-f\d])([a-f\d])([a-f\d])([a-f\d])$/i,(t,e,s,o,r)=>"#"+e+e+s+s+o+o+r+r).substring(1).match(/.{2}/g).map(t=>parseInt(t,16)),ae="6v7ic,2rwzo,6nvic,58jgo,55eyo,jz6bo,933m7,3ugt8,34ao,7k,b28,m0,20o0o,9a7vy,jbmjj,jf63j,ivhmn,etrs7,ju8e7,jalrz,jeyks,jwdj3,jwdlv,2t8g,2t8s,34yo,lskg,m2yo,jf4lo,jysjy,98ruh,j8htq,9v7zj,j8d32,ju78f,ju8t4,9ul2n,g44e1,jykrj,jewdq,g4rbt,fgsgv,hha5t,g6xgz,98rou,j8d7c,98uwe,j8d7d,9xgxq,jykqs,g3zn2,g3z9g,b1ipn,h4qu3,c8oz2,jhyfz,,,,".split(","),H={},ne="#",re="%",Ht=async(i,t,e)=>{const s=i+e+t;if(H[s])return;const o=5*t,r=1*t,l=o+r,g=l*i.length-r,m=new ImageData(g,o),[w,y,U,b]=Zt(e);i.replace("!","@").toUpperCase().split("").forEach((S,D)=>{const C=S===" "?"0":ae[S.charCodeAt(0)-35];String(parseInt(C,36).toString(2)).padStart(25,"0").split("").forEach((te,ee)=>{if(te!=="0")for(let st=0;st<t;st++){const yt=ee*t,se=(D*l+yt%o+t*g*Math.floor(yt/o)+g*st)*4;for(let it=0;it<t;it++){const Y=it*4+se;m.data[Y]=w,m.data[Y+1]=y,m.data[Y+2]=U,m.data[Y+3]=b||255}}})});const P=await createImageBitmap(m);H[s]=P},lt=({text:i,color:t=n.black,textAlign:e="left",textBaseline:s="top",size:o=2,maxLetters:r=999,...l})=>{const g=Math.round(l.x),m=Math.round(l.y);i||(i=" ");const w=5*o,y=1*o,U=w+y,b=U*i.length-y,P=i+t+o,S=e==="left"?0:e==="center"?Math.round(b/2):b,D=s==="top"?0:s==="middle"?Math.round(w/2):w;if(H[P]){const C=r*U;c.drawImage(H[P],0,0,C,U,g-S,m-D,C,U)}else Ht(i,o,t).then(()=>{c.drawImage(H[P],g-S,m)})},dt=(i,t,e)=>{i.forEach(s=>{t.forEach(o=>Ht(s,e,o))})},he=()=>{for(let i=1;i<=13;i++)dt([`Level ${(" "+i).slice(-2)}`],[n.black],4)};function R(i,t,e){return Math.max(Math.min(i,e),t)}function le(i,t){const e=new RegExp(`(.{1,${t}})(\\s|$)`,"g"),s=[];let o;for(;(o=e.exec(i))!==null;)s.push(o[1].trim());return s}function ft(i){return{x:Math.round(i.x),y:Math.round(i.y)}}function Gt({x:i,y:t},e){return{x:i+e.x,y:t+e.y}}function ce(i,t=.3){const e={...i};return Object.keys(e).forEach(s=>{const o=1+Math.random()*t;e[s]=e[s]*o}),e}const ot=i=>Math.round(i/15)*15,j=(i,t)=>i[0]+(i[1]-i[0])*t,Z=(i,t,e)=>({x:i.x+t,y:i.y+e});function de(i){const t=[...i];for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}const n={black:"#1F0A00",white:"#FFFCEA",gray:"#A29782",light:"#CEC6AD"},fe=Object.values(n).join("").replace(/#/g,""),pe=n.black.repeat(4).replace(/#/g,""),N="@@@@@@PUUE@PjjjA@ijjF@dZjY@PjjjA@iZeF@djjZ@PUUUAPijjFPdjjZQPUUUQ@TUUA@";var u=(i=>(i[i.base=0]="base",i[i.falling=1]="falling",i[i.jumping=2]="jumping",i[i.dead=3]="dead",i[i.broom=4]="broom",i[i.boss1=5]="boss1",i[i.boss2=6]="boss2",i[i.boss3=7]="boss3",i[i.boss4=8]="boss4",i[i.chair=9]="chair",i[i.table=10]="table",i[i.plant=11]="plant",i[i.camera=12]="camera",i[i.coffee=13]="coffee",i[i.bigCoffee=14]="bigCoffee",i[i.coffeMachine=15]="coffeMachine",i[i.wheel=16]="wheel",i[i.npc1=17]="npc1",i[i.npc2=18]="npc2",i[i.npc3=19]="npc3",i[i.walk1=20]="walk1",i[i.walk2=21]="walk2",i[i.walk3=22]="walk3",i[i.walk4=23]="walk4",i[i.walk5=24]="walk5",i[i.walk6=25]="walk6",i[i.fire1=26]="fire1",i[i.fire2=27]="fire2",i))(u||{});const ge=[N+"PA@E@@E@T@@T@PA@","@@@@@@@@@@@@@@@@@TUUA@djjZ@PjjjA@ijjF@dZjY@PjjjA@iZeF@TUUU@TjjjEDijjFQTUUUD@UUU@@@EPA@","@TUUA@djjZ@PjifA@ijjF@djUZ@PjjjQ@ijjFATUUUATjjjADiejFPTUUU@@UUU@@PAU@@@@U@@@@T@@@@@@@@","@@@@@@@@@@@@@@@@@@@@@@@@@@@PUUUA@YijZ@eejjFUVjjZEYiZfEdfffFPZZfYUiiijUUUUUE@D@@@@@U@@@","@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@E@@@@}A@@`U_ji`@tgAh@@}U`@@PoF@@@djA@@PjZ@@@TUA","@@@@@@@UUE@@UUUA@ijjU@dfZZAPjYjE@iifV@ifZZAdjjjFPjUeZ@iZUjAPjjjA@TejU@UijUEUUjUUTUUUUA","@@@@@@PUUE@PeZUAPijjU@ijjVAeUVYUTjifVQijjZEejjjUPjUjVAijjZ@PjjZ@@TiU@@@dF@@PUVUAPUUUU@","@TUU@@djjF@djjjAPUUUF@ijjV@djjjAPVjeF@ijjZ@djjjAPjUjF@djjF@@ejF@@@iF@@TeZU@TUYUEPUUUU@","@PA@E@PU@UAPUUUU@UiVUAPijUA@djZA@PfiF@@YfZ@@djjATdjjFPejjZ@djjZ@@UUU@@@@U@@@@UE@@PUUE@","p@@@@kC@@@lN@@@pz@@@@k@|njjCp~jjN@kkjz@lnjjCpzjjN@k@ljjjCpjjjN@kz@l~kCp@|O@","@C@kjjz@kjjjNkjjjjojjjj~jjjjzkjjjjojjjj~kjjj~{jjjns~oCljjjCpO@kCpz@lN@kCp@|O@","@pO@@|jjO@ljzjCpjznNpjjnjCknjjNlnkjzpjkzjskjzn~ojjnzokjjz~zzkjjjjjjjjz|@","@pOpO@pjsjC@kNkNLlzozpCj@{sjz@l~kjCpzojN@{s@|@pN@p@pjC@@p~{@@pNpN@pN@lCpN@@{@O@@pC","@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|C@@@pW@@@@C@@@|K@@@@J@@@@@@@@@@@@@@@@@","@@@@@@@@@@@@TUE@@djjA@d~Z@T^UmAdZUUFPfVUZ@YjjjEtjjjfQujj^Fi}_ZPZUUZ@djjZ@@UUU@@@@@@@","PUUUU@ijjjAdjjjFPjjjZ@UUUUAtGPUUu^@@@PAPUEmGPTVt_@QYQADeE}G@TUt_@UUUAtGPUUUU@","@@C@@pkzC@pzz@p~Np~oC{N{oo~~{{os~oC{Np~N@l~oN@@ojO@@@C@@","@@@@@@TUUA@TejZATUffEPUYZV@UejZAPeZiA@djjF@PUiV@PUYfEPTUfEAQUeUDPUUUE@TUUE@@E@E@@@@@@@","@@@@@@PUUA@PjjZ@@ijjA@dZZF@PjiY@@iZiA@djjF@PUUU@PiZiEPdjjFAQUUUDPUUUE@PAPA@@E@E@@@@@@@","@@@@@@PUUA@PUUU@@ijjA@TUUE@PZiU@@ijjA@djjF@PUUU@PUUVEPTUYEAQUUUDPUUUE@PAPA@@E@E@@@@@@@",N+"PA@E@@@@T@@@@PA@",N+"@E@E@@T@T@@@@PA@",N+"@EPA@@T@E@@PA@@@",N+"@EPA@@T@@@@PA@@@",N+"@E@E@@T@T@@PA@@@",N+"@E@E@@T@T@@@@PA@","@|@L|psO|Lk~szlzC|O@","C@@sp||@so{ljNlzC|O@"],xt=[];let Q=[],Jt=[],wt=[];function ue(i){return-(Math.cos(Math.PI*i)-1)/2}const d=256,h=320,X=d/16,It=h/16;class me{constructor(){this.charFrame=0,this.ready=!1,window.c=c2d.getContext("2d",{alpha:!1}),c.imageSmoothingEnabled=!1}async init(){const t=performance.now();return Promise.all(ge.map((e,s)=>this.preLoadIcon(s,e,!1))).then(()=>{console.debug(`Loaded icons in ${performance.now()-t}ms`),Q=[17,18,19],Jt=[5,6,7,8],wt=[20,21,22,23,24,25],this.ready=!0})}async preLoadIcon(t,e,s){const o=[],r=s?pe:fe;[...e].map(w=>{const y=w.charCodeAt(0);o.push(y&3),o.push(y>>2&3),o.push(y>>4&3)});const l=Math.floor(Math.sqrt(o.length)),g=new ImageData(l,l);for(let w=0;w<l;w++)for(let y=0;y<l;y++)if(o[w*l+y]){const U=6*(o[w*l+y]-1),[b,P,S,D]=Zt("#"+r.substring(U,U+6)),C=(y+w*l)*4;g.data[C]=b,g.data[C+1]=P,g.data[C+2]=S,g.data[C+3]=D||255}const m=await createImageBitmap(g);xt[t]=m}drawIcon(t,e,s=!1,o=!1,r=!1){const l=xt[t];l&&(c.save(),s&&(c.filter="brightness(0)"),c.translate(e.x+(o?l.width:0),e.y),c.save(),c.scale(o?-1:1,1),r&&(c.beginPath(),c.rect(0,0,16,8),c.clip()),c.drawImage(l,0,0),c.restore(),c.restore())}drawWalkingIcon(t,e,s){this.drawIcon(wt[t],e,!1,s)}drawText(t){lt(t)}clear(){c.clearRect(0,0,h,d),c.fillStyle=n.white,c.fillRect(0,0,h,d)}drawRect(t,e,s,o){const{x:r,y:l}=ft(t);c.fillStyle=s,c.fillRect(r,l,e.x,e.y),c.fillStyle=o,c.fillRect(r+1,l+1,e.x-2,e.y-2)}drawLine(t,e,s,o,r){let l=Math.round(t),g=Math.round(e);s=Math.round(s),o=Math.round(o);let m=s-l,w=o-g,y=Math.max(Math.abs(m),Math.abs(w));m/=y,w/=y,c.fillStyle=r,c.beginPath();for(let U=0;U<=y;U++)c.rect(Math.round(l)-1,Math.round(g)-1,3,3),l+=m,g+=w;c.fill()}drawControls(){c.save(),c.translate(h/2,80),[{x:-50,y:0},{x:-50,y:22},{x:-72,y:22},{x:-28,y:22}].forEach(({x:o,y:r})=>{this.drawRect({x:o-22/2,y:r},{x:20,y:20},n.gray,n.gray),this.drawRect({x:o-22/2,y:r},{x:18,y:18},n.light,n.light)}),this.drawText({text:"move with arrows or wasd",x:-50,y:20*3,textAlign:"center",size:1}),[["esc","exit game"],[" P ","pause game"]].forEach(([o,r],l)=>{const g=l*22;this.drawRect({x:40,y:g},{x:26,y:20},n.gray,n.gray),this.drawRect({x:40,y:g},{x:24,y:18},n.light,n.light),this.drawText({text:`${o}  ${r}`,x:45,y:g+8,size:1})}),c.restore(),c.save(),c.restore()}drawHouseShadow(t,e){c.save(),c.globalAlpha=.5;const s=-1+e,o=e;c.transform(o,s,0,1,0,0),c.beginPath(),c.moveTo(0,d),t.forEach(([r,l])=>{c.lineTo(r*h,l*d)}),c.fillStyle=n.black,c.clip(),c.fillRect(0,0,h,d),c.restore()}drawHouseFace(t,e){e=Math.min(1,e),c.save();const s=.5*(-1+e),o=Math.pow(e,3);c.transform(o,s,0,1,0,0),c.beginPath(),c.moveTo(0,d),t.forEach(([l,g])=>{c.lineTo(l*h,g*d)}),c.fillStyle=n.white,c.strokeStyle=n.light,c.stroke(),c.save(),c.clip();const r=Math.round(h/30);c.fillRect(0,0,h,d);for(let l=0;l<30;l++)c.strokeRect(r*l,0,r,d);c.restore(),this.drawLine(t[1][0]*h,t[1][1]*d,t[2][0]*h,t[2][1]*d,n.light),this.drawLine(t[2][0]*h,t[2][1]*d,t[10][0]*h,t[10][1]*d,n.light),c.restore()}drawHouse(t,e,s){const o=[[0,0],[.5,0],[1,.5],[1-s,.5],[1-s,.5-e.y],[1-(s+e.x),.5-e.y],[1-(s+e.x),.5+e.y],[1-s,.5+e.y],[1-s,.5],[1,.5],[.5,1],[0,1]];this.drawHouseShadow(o,t),this.drawHouseFace(o,t)}drawBoatWheel(t){const o=2*Math.PI/8;for(let g=0;g<8;g++){const m=o*(g+t*8);c.save(),c.translate(h/2,d/2),this.drawLine(40*Math.cos(m),40*Math.sin(m),40*Math.cos(m+o),40*Math.sin(m+o),n.gray),this.drawLine(0,0,2*40*Math.cos(m),2*40*Math.sin(m),n.gray),c.restore()}const r=d/2+40/2+Math.sin(2*Math.PI*t)*5,l=d/2+40/2+Math.cos(2*Math.PI*t)*5;this.drawLine(0,r,h,l,n.gray),c.beginPath(),c.moveTo(0,r),c.lineTo(h,l),c.lineTo(h,d),c.lineTo(0,d),c.lineTo(0,r),c.fill()}renderPause(){c.fillStyle=n.black+"DD",c.fillRect(0,0,h,d),["paused","press 'P' to continue"].forEach((t,e)=>{[n.black,n.white].forEach((s,o)=>{lt({text:t,x:h/2-o*1,y:d/2+e*30-30-o*1,textAlign:"center",color:s,size:3-e})})})}}const f=new me,x=16;class ye{constructor(){this.frameDuration=60,this.timeAccumulator=0,this.currentFrame=0,this.size={x,y:x},this.pos={x:0,y:0},this.mirror=!1,this.holding=[],this.dead=!1,this.velocity={x:0,y:0}}setPos(t,e){this.pos=ft({x:t,y:e})}move(){this.pos=Gt(this.pos,this.velocity)}draw(t){f.drawIcon(t,this.pos,!1,this.mirror),this.drawHolding()}drawHolding(){this.holding.forEach((t,e)=>{f.drawIcon(t,{...this.pos,y:this.pos.y-(e+1)*12})})}drawWalking(t){this.timeAccumulator+=t,this.timeAccumulator>=this.frameDuration&&(this.currentFrame=(this.currentFrame+1)%6,this.timeAccumulator-=this.frameDuration),f.drawWalkingIcon(this.currentFrame,this.pos,this.mirror),this.drawHolding()}drawStanding(){this.draw(u.base)}drawDead(){this.draw(u.dead)}drawJumping(){this.draw(u.jumping)}drawFalling(){this.draw(u.falling)}drawDrowning(){f.drawIcon(u.jumping,this.pos,!1,this.mirror,!0)}hold(t){this.holding.push(t)}pop(){this.holding.pop()}}const a=new ye,xe=(i,t)=>(t-i)/t,Wt=i=>{const t=new AudioContext,e=t.createBuffer(1,96e3,48e3),s=e.getChannelData(0);for(let r=96e3;r--;)s[r]=i(r);const o=t.createBufferSource();o.buffer=e,o.connect(t.destination),o.start()},jt=i=>Wt(t=>{var e=2e4;if(t>e)return 0;var s=xe(t,e);return .2*Math.tan(Math.cbrt(Math.sin(t/(145-5*i))))*s*s}),we=()=>Wt(i=>.1*Math.sin(i/50+Math.random()*50)*(8e3-i%8e3)/5e3*Math.exp(-i/8e3)),je=function(i,t,e){const s=t*3e3;return i>s?0:Math.sin(e*i/25-Math.sin(i/5)*.5)*Math.sin(i/(s/t)*Math.PI)*.2},Ue=(i,t,e)=>{const s=new AudioContext,o=(i+.25)*3e3,r=s.createBuffer(1,o,48e3),l=r.getChannelData(0);for(let m=o;m--;)l[m]=je(m,i,t);const g=s.createBufferSource();g.buffer=r,g.connect(s.destination),g.start(),g.onended=e},Se=(i,t)=>{const e=1+(Math.random()-.5)*.5;Ue(i,e,t)};let V=!1;const Ee=i=>{V=!0;const t=i.replace(/[^a-zA-Z\s]/g,"").split(" ");let e=0,s=60,o=0;const r=()=>{if(V&&e<t.length){o=performance.now();const l=Math.floor(t[e].replace(/[^a-zA-Z\s]/g,"").length/2)||1;Se(l,()=>{const g=performance.now()-o;o=performance.now();const m=Math.max((l+1)*s-g,0);setTimeout(r,m)}),e++}else V=!1};r()},Pe=()=>{V=!1};let _=0,ct=0;const Ut=30;let Yt="",$t="",Vt;function q(i,t){Yt=i,$t=t,Vt=Jt[p.boss],_=0,ct=0,Ee(t)}function _t(i,t=!1){_+=i,_>=Ut&&(ct++,_-=Ut),f.drawRect({x:5,y:d-70},{x:h-10,y:50},n.light,n.white),f.drawRect({x:8,y:d-67},{x:h-16,y:44},n.light,n.white),f.drawText({text:Yt,x:12,y:d-63,size:2,color:n.gray}),le($t,40).forEach((e,s)=>{f.drawText({text:e,x:12,y:d-45+s*8,size:1,maxLetters:ct-40*s})}),c.save(),c.translate(h-45,d-60),c.save(),c.scale(2,2),f.drawIcon(Vt,{x:0,y:0}),c.restore(),c.restore(),t&&f.drawText({text:"Press Enter to continue",x:h/2,y:d-15,textAlign:"center",color:n.gray,size:1})}class ve{constructor(){this.startTime=0,this.isPlaying=!1}async start(){this.isPlaying||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),await this.audioContext.resume(),await this.audioContext.audioWorklet.addModule("a.js"),this.musicProcessorNode=new AudioWorkletNode(this.audioContext,"music-processor"),this.musicProcessorNode.connect(this.audioContext.destination),this.isPlaying=!0)}setPlayHighNotes(t){var e;(e=this.musicProcessorNode)==null||e.port.postMessage({name:"voices",high:t})}stop(){var t;this.isPlaying&&((t=this.musicProcessorNode)==null||t.disconnect(),this.isPlaying=!1)}speedUp(){var t;(t=this.musicProcessorNode)==null||t.port.postMessage({name:"speed-up"})}}const F=new ve,tt="13_terrible_stunts_game_";function St(){const i=localStorage.getItem(`${tt}save`)||"";return parseInt(i,10)||0}function qt(i){localStorage.setItem(`${tt}save`,i.toString())}function be(i){localStorage.setItem(`${tt}hs`,i.toString())}function Me(){const i=localStorage.getItem(`${tt}hs`)||"";return parseInt(i,10)||0}let G=[];function T(i,t,e=0,s=0){G.push({callback:i,time:t,timeLeft:t+s,repeat:e})}function Te(){G=[]}function Ae(i){for(let t=G.length-1;t>=0;t--){const e=G[t];if(!e)return;e.timeLeft-=i,e.timeLeft<=0&&(e.callback(),e.repeat--<=0?G.splice(t,1):e.timeLeft=e.time)}}class Ce{onEnter(){F.stop(),F.start().then(()=>{F.setPlayHighNotes(!1)});const{name:t,intro:e}=p.getBoss();q(t,e)}onLeave(){Pe()}onUpdate(t){f.drawControls(),_t(t,!0)}onConfirm(){p.start()}}const pt=new Ce;class A{constructor(t={x:0,y:0},e={x:0,y:0}){this.hasCollided=!1,this.pos=t,this.size=e}update(t){this.hasCollided=!1}collision(){const t=a.pos.x+a.size.x,e=a.pos.y+a.size.y,s=this.pos.x+this.size.x,o=this.pos.y+this.size.y,r=a.pos.x<s,l=t>this.pos.x,g=a.pos.y<o,m=e>this.pos.y,w=r&&l&&g&&m;if(!w)return this.hasCollided=!1,{collides:!1,standsOn:!1,right:!1,left:!1,bottom:!1,top:!1};const y=s-a.pos.x,U=t-this.pos.x,b=o-a.pos.y,P=e-this.pos.y,S=Math.min(y,U,b,P);return this.hasCollided=!0,{collides:w,standsOn:this.standsOn(),right:S===y,left:S===U,bottom:S===b,top:S===P}}standsOn(){if(a.velocity.y<0)return!1;const t=a.pos.x+a.size.x-3,e=a.pos.y+a.size.y,s=this.pos.x+this.size.x,o=this.pos.y+2;return a.pos.x+5<s&&t>this.pos.x&&a.pos.y<o&&e>=this.pos.y}render(t,e){f.drawRect(this.pos,this.size,e||t,t)}}class O extends A{constructor(t,e){super(t,e),this.stroke=n.gray,this.fill=n.gray}setColor(t,e){this.stroke=t||"",this.fill=e||this.stroke}update(){f.drawRect(this.pos,this.size,this.stroke,this.fill)}}const v=130,k=50;class z extends O{constructor(t,e=3){const s={x:v,y:k*e};super(ft(t),s),this.floors=0,this.floors=e}update(){f.drawRect(this.pos,this.size,n.gray,n.light);for(let t=0;t<this.floors;t++){const e={x:this.pos.x-1,y:this.pos.y+t*k},s={x:this.size.x+2,y:6};f.drawRect(e,s,n.gray,n.gray);for(let o=0;o<5;o++){c.save(),c.translate(this.pos.x+8+25*o,this.pos.y+14+k*t);const r=12,l=14;f.drawRect({x:0,y:0},{x:l,y:r},n.gray,n.white),f.drawRect({x:0,y:r},{x:l,y:r},n.gray,n.white),c.restore()}}}}class ke{constructor(){this.progress=0,this.isStarting=!1,this.fadeOut=0,this.building=new z({x:h/2-v/2,y:0},5)}onEnter(){this.progress=0,this.isStarting=!1}onUpdate(t){for(let e=0;e<h;e+=16)f.drawIcon(u.plant,{x:e,y:183});if(this.building.update(),c.fillStyle=n.gray,c.fillRect(0,200,h,100),f.drawRect({x:h/2-14,y:161},{x:14,y:39},n.gray,n.white),f.drawRect({x:h/2,y:161},{x:14,y:39},n.gray,n.white),f.drawRect({x:h/2-50,y:130},{x:100,y:20},n.black,n.black),f.drawText({text:"movie studio",x:h/2,y:138,textAlign:"center",size:1,color:n.white}),this.progress<1?(this.progress+=t/3e3,a.drawWalking(t)):(a.drawStanding(),f.drawText({text:"Press ENTER to apply for job",x:h/2,y:d-15,textAlign:"center",color:n.white,size:1})),a.setPos(-100+this.progress*(h/2+92),194),this.isStarting){this.fadeOut=Math.min(1,this.fadeOut+t/1500);const e=n.white+(Math.round(this.fadeOut*16/3)*3).toString(16).repeat(2);f.drawRect({x:0,y:0},{x:h,y:d},e,e)}}onConfirm(){this.progress>=1&&!this.isStarting&&(this.isStarting=!0,we(),T(()=>{M.setState(pt)},1500))}}const Et=new ke,at=["Story mode","Restart story","Endless mode"];class ze{constructor(){this.selectedButton=0}onEnter(){F.stop()}onUpdate(t){f.drawText({text:"Levels",x:h/2,y:30,textAlign:"center",color:n.gray,size:3});const e=16;let s=h/2-2*e,o=0;const r=130;[...at].forEach(l=>{f.drawText({text:l,x:s,y:r+o++*12,color:n.black,size:1})}),f.drawText({text:"&",x:s-10,y:r+this.selectedButton*12,color:n.black,size:1}),f.drawText({text:`High score: ${p.highScore}`,x:s,y:r+o++*12,color:n.light,size:1}),f.drawText({text:p.easyMode?"# Easy Mode Enabled #":"Press E for easy mode",x:h/2,y:d-35,textAlign:"center",color:p.easyMode?n.gray:n.light,size:1}),f.drawText({text:"Press ENTER to start",x:h/2,y:d-15,textAlign:"center",color:n.gray,size:1}),s=h/2-4*e,c.save(),c.translate(s,80),f.drawRect({x:-16,y:0},{x:e*10,y:e*2},n.light,n.light),[u.boss1,u.boss2,u.boss3,u.boss4].forEach((l,g)=>{c.save(),c.scale(2,2);const m={x:e*g,y:0};f.drawIcon(l,m,p.boss<=g),c.restore()}),c.restore(),E.isKeyE&&!E.previousState.isKeyE&&(p.easyMode=!p.easyMode)}onUp(){this.selectedButton--,this.selectedButton<0&&(this.selectedButton=at.length-1)}onDown(){this.selectedButton++,this.selectedButton>at.length-1&&(this.selectedButton=0)}onConfirm(){this.selectedButton===0?(p.endless=!1,M.setState(p.boss===0?Et:pt)):this.selectedButton===1?(p.endless=!1,p.boss=0,M.setState(Et)):(p.endless=!0,p.nextLevel())}}const gt=new ze,B=200,$=50;class W{constructor(){this.isStarting=!1,this.isEnding=!1,this.inTransition=!1,this.animationDuration=500,this.animationTimer=0,this.animationProgress=0,this.maxTime=10,this.timeLeft=0,this.text="",this.gameOver=!1,this.confirmCallback=()=>{}}onEnter(){this.maxTime=p.easyMode?20:10,this.timeLeft=this.maxTime,this.isStarting=!1,this.isEnding=!1,this.inTransition=!1,this.gameOver=!1,a.velocity={x:0,y:0},F.start(),F.setPlayHighNotes(!0),this.start()}onLeave(){Te()}queryControls(t){}stop(){a.velocity={x:0,y:0}}start(){this.animationTimer=0,this.isStarting=!0}getHearts(t=0){return ne.repeat(p.lives-t)+re.repeat(I-(p.lives-t))}timeOver(){this.isEnding||this.loseLife()}loseLife(){this.stop();const t=`Oh no! ${this.getHearts()}`,e=`Oh no! ${this.getHearts(1)}`,s=Math.floor(B/(6*t.length));dt([t,e],[n.black],s),this.text=t,this.animationTimer=0,this.isEnding=!0,p.lives--,T(()=>{this.text=e},200,3,this.animationDuration),T(()=>{this.text=t},200,2,this.animationDuration+100),p.lives<1?T(()=>{if(this.gameOver=!0,this.text="you're fired!",this.inTransition=!0,p.endless)p.level>p.highScore&&(p.highScore=p.level,be(p.level));else{const{name:o,gameover:r}=p.getBoss();q(o,r)}this.confirmCallback=()=>{M.setState(K)}},this.animationDuration*4):T(()=>{this.nextLevel()},this.animationDuration)}nice(){this.stop(),this.animationTimer=0,this.isEnding=!0,this.text="Nice!",this.nextLevel()}endBoss(){const{name:t,outro:e}=p.getBoss();p.speedUp=!1,this.inTransition=!0,q(t,e),this.confirmCallback=()=>{if(p.boss===3)this.text="# You're a star! #",qt(p.boss),this.confirmCallback=()=>{M.setState(gt)};else if(p.lives<4){for(let s=p.lives;s<I;s++)T(()=>{jt(26+(s-p.lives)*.5),this.text=` ${this.getHearts(p.lives-s-1)} `},0,0,this.animationDuration*s);T(()=>{p.nextBoss()},0,0,this.animationDuration*(I+1)),this.confirmCallback=()=>{}}else p.nextBoss()}}phaseTwo(){const{name:t,final:e}=p.getBoss();q(t,e),this.inTransition=!0;let s=this.animationDuration;for(let o=13;o>=1;o--)s+=100+250*(13-o)/13,T(()=>{jt(o),this.text=`Level ${(" "+o).slice(-2)}`},s,0,this.animationDuration*2);T(()=>{this.text="SPEED UP!",F.speedUp(),T(()=>{p.speedUp=!0,p.level=-1,p.nextLevel()},1e3,0,this.animationDuration)},s+2e3,0,this.animationDuration*2)}nextLevel(){!p.endless&&p.level==12?p.speedUp?this.endBoss():this.phaseTwo():T(()=>{p.nextLevel()},this.animationDuration*3)}onUpdate(t){!this.isEnding&&!this.isStarting&&(this.queryControls(t),this.timeLeft=Math.max(0,this.timeLeft-t/1e3),Math.round(this.timeLeft)<=0&&this.timeOver())}postRender(t){(this.isEnding||this.isStarting)&&(this.animationTimer+=t,this.animationTimer<=this.animationDuration&&(this.animationProgress=ue(this.animationTimer/this.animationDuration)),this.animationTimer>0&&this.renderPanel(),this.animationTimer>this.animationDuration*2&&this.isStarting&&(this.isStarting=!1)),this.inTransition&&!p.endless&&_t(t,this.inTransition),this.renderStats()}renderStats(){[[this.getHearts(),"left",7],[Math.round(this.timeLeft),"center",h/2],[`Lvl ${p.level+1}`,"right",h-7]].forEach(([s,o,r])=>{[n.light,n.black].forEach((l,g)=>{f.drawText({text:s.toString(),x:r-g,y:7-g,textAlign:o,color:l,size:2})})});const e=Math.round(100*this.timeLeft/this.maxTime/2)*2;f.drawRect({x:h/2-e/2,y:20},{x:e,y:8},n.gray,n.white)}renderPanel(){const t=h*this.animationProgress-h/2,e=d*this.animationProgress-d/2,s=this.gameOver?n.black:n.white,o=this.gameOver?n.white:n.black;f.drawRect({x:h-t-B/2+8,y:d-e-$/2+8},{x:B,y:$},n.black,n.black),f.drawRect({x:t-B/2,y:e-$/2},{x:B,y:$},n.black,s),f.drawText({text:this.text,x:t,y:e,textAlign:"center",textBaseline:"middle",size:Math.floor(B/(6*this.text.length)),color:o})}onConfirm(){this.confirmCallback()}}class et extends W{constructor(){super(...arguments),this.maxSpeed=4,this.acceleration={x:.3,y:.05},this.jumpSpeed=7,this.maxFallSpeed=14,this.timeJumping=0,this.maxTimeJumping=100,this.readyToJump=!0,this.jumps=0,this.maxJumps=2,this.platforms=[],this.deathColliders=[],this.isGrounded=!0,this.maxY=d*2,this.minY=-256,this.yOffset=0}onEnter(){super.onEnter(),this.jumps=0,Object.assign(a,{mirror:!1,dead:!1,pos:{x:20,y:20},velocity:{x:0,y:0}})}hasWon(){var t;return!this.isEnding&&((t=this.goalCollider)==null?void 0:t.collision().collides)}onUpdate(t){if(p.level<7&&!p.speedUp&&f.drawText({text:"You can double jump",x:h/2,y:80,color:n.light,size:1,textAlign:"center"}),!this.isEnding&&this.deathColliders.some(e=>e.collision().collides)&&(a.dead=!0,this.loseLife()),!this.isEnding&&this.hasWon()&&this.nice(),!this.isEnding){a.velocity={x:R(a.velocity.x,-this.maxSpeed,this.maxSpeed),y:a.velocity.y},a.setPos(R(a.pos.x+a.velocity.x,0,h-x),R(a.pos.y+Math.min(this.maxFallSpeed,a.velocity.y*t/16),this.minY,this.maxY)+1);const e=this.platforms.find(s=>s.standsOn());e?(a.pos.y=e.pos.y-x,a.velocity.y=0,this.timeJumping=0,this.jumps=0,this.isGrounded=!0):(a.velocity.y+=this.acceleration.y*t,this.isGrounded=!1)}c.save(),c.translate(0,this.yOffset),this.goalCollider&&f.drawText({text:"(",x:this.goalCollider.pos.x+this.goalCollider.size.x/2-5,y:this.goalCollider.pos.y-20-Math.round(this.timeLeft*8)%2}),[...this.platforms,...this.deathColliders,this.goalCollider].forEach(e=>{e==null||e.update(t)}),this.drawExtras(),this.renderCharacter(t),c.restore(),super.onUpdate(t)}drawExtras(){}renderCharacter(t){a.dead?a.drawDead():a.velocity.x===0&&a.velocity.y===0?a.drawStanding():a.velocity.y===0?a.drawWalking(t):a.velocity.y>0?a.drawFalling():a.velocity.y<0&&a.drawJumping()}queryControls(t){E.isUp&&this.jumps<this.maxJumps&&(!this.isGrounded||this.readyToJump)?E.previousState.isUp?this.timeJumping<this.maxTimeJumping&&(this.readyToJump=!1,this.timeJumping+=t,a.velocity.y=-this.jumpSpeed):(this.readyToJump=!0,this.timeJumping=0,a.velocity.y=Math.min(0,a.velocity.y),this.jumps++):E.isUp||(this.readyToJump=!0),this.isGrounded&&(E.isLeft?a.velocity.x-=this.acceleration.x*t:E.isRight?a.velocity.x+=this.acceleration.x*t:a.velocity.y==0&&(a.velocity.x>0?a.velocity.x=Math.max(0,a.velocity.x-2*this.acceleration.x*t):a.velocity.x<0&&(a.velocity.x=Math.min(0,a.velocity.x+2*this.acceleration.x*t))))}}const Pt={distance:[0,40],heightDifference:[-10,20]};let ut=class extends et{constructor(){super(...arguments),this.acceleration={x:.01,y:.05}}onEnter(){super.onEnter(),this.text="Jump over";const t=p.getDifficulty(),e=j(Pt.distance,t),s=j(Pt.heightDifference,t);this.platforms=[new z({x:2-e,y:100+x+s}),new z({x:h-102+e,y:120+x-s})],this.deathColliders=[new A({x:0,y:d+20},{x:h,y:10})];const o=h-102+e;this.goalCollider=new A({x:o,y:120+x-1-s},{x:Math.min(h-o,v),y:10})}};const vt=new ut,nt={buildingHeight:[100,180],trampolinSize:[4,2.5],spaceApart:[.4,.5]};class De extends ut{constructor(){super(...arguments),this.trampolin=new A({x:h/2-x*3/2,y:d-40},{x:x*3,y:15})}onEnter(){super.onEnter(),this.text="Jump over";const t=p.getDifficulty(),{buildingHeight:e,trampolinSize:s,spaceApart:o}=ce({buildingHeight:j(nt.buildingHeight,t),trampolinSize:j(nt.trampolinSize,t),spaceApart:j(nt.spaceApart,t)}),r=new O({x:0,y:d-20},{x:h,y:20});this.deathColliders=[r],r.setColor(n.gray,n.gray),this.platforms=[new z({x:-130*o,y:d-e+x},4),new z({x:h-v*(1-o),y:d-e+x},4)];const l=this.platforms[1].pos.x;this.goalCollider=new A({x:l,y:this.platforms[1].pos.y-1},{x:Math.min(h-l,v),y:1});const g=x*s;this.trampolin=new A({x:h/2,y:d-40},{x:g,y:15})}onUpdate(t){const{collides:e,standsOn:s}=this.trampolin.collision();(e||s)&&(a.velocity.y=-a.velocity.y);const o=this.trampolin.pos,r=this.trampolin.size;[{pos:{x:o.x+3,y:o.y+r.y-1},size:{x:3,y:8}},{pos:{x:o.x-6+r.x,y:o.y+r.y-1},size:{x:3,y:8}},{pos:o,size:r}].forEach(({pos:l,size:g})=>{f.drawRect(l,g,n.black,n.white)}),super.onUpdate(t)}}const bt=new De,Mt={goalSize:[4,2],buildingHeight:[100,50]};class Le extends ut{constructor(){super(...arguments),this.goalSize=0,this.buildingHeight=0}onEnter(){super.onEnter(),this.text="Land safely";const t=p.getDifficulty();this.goalSize=j(Mt.goalSize,t),this.buildingHeight=j(Mt.buildingHeight,t);const e=new O({x:0,y:d-20},{x:h,y:20});e.setColor(n.gray,n.gray),this.deathColliders=[e];const s=new O({x:h-102,y:d-25},{x:x*this.goalSize,y:5});s.setColor(n.black,n.white),this.goalCollider=s,this.platforms=[new z({x:-20,y:this.buildingHeight+x},4),new O({...s.pos},{...s.size})],s.pos.y--,s.size.y+=3}hasWon(){return!this.isEnding&&this.goalCollider.collision().standsOn}}const Re=new Le,Tt={swingTime:[2500,1800],ropeHeight:[120,100]};class Fe extends et{constructor(){super(...arguments),this.acceleration={x:.01,y:.05},this.rope=new A({x:0,y:0},{x:5,y:5}),this.ropeHeight=110,this.swingTime=2e3,this.swingPos=1,this.grabbing=!1,this.isJumping=!1,this.maxSpeed=3}onEnter(){super.onEnter(),this.text="Swing over",this.grabbing=!1,this.isJumping=!1,this.platforms=[new z({x:-130/2,y:100+x}),new z({x:h-v/2,y:100+x})],this.deathColliders=[new A({x:0,y:d+20},{x:h,y:10})];const t=h-v/3;this.goalCollider=new A({x:t,y:100+x-1},{x:Math.min(h-t,v),y:10});const e=p.getDifficulty();this.swingTime=j(Tt.swingTime,e),this.ropeHeight=j(Tt.ropeHeight,e)}onUpdate(t){super.onUpdate(t),this.swingPos+=t/this.swingTime;const e=Math.sin(this.swingPos*2*Math.PI),s=h/2+this.ropeHeight*Math.sin(e),o=this.ropeHeight*Math.cos(e);f.drawLine(h/2,-20,s,o,n.gray),this.rope.pos={x:s,y:o},this.rope.render(n.white,n.black),this.isEnding||(!this.isJumping&&!this.grabbing&&this.rope.collision().collides&&(this.grabbing=!0),!this.isJumping&&this.grabbing&&(a.pos=Z(this.rope.pos,-8,-24)),this.isJumping&&this.grabbing&&(a.velocity={x:Math.sin(e)*4,y:-Math.cos(e)},this.grabbing=!1),this.isGrounded&&(this.isJumping=!1,this.grabbing=!1))}onUp(){this.isJumping=!0}}const Ne=new Fe;class mt extends W{constructor(){super(...arguments),this.entities=Array.from({length:16},()=>[]),this.maxSpeed=3,this.acceleration=.02,this.plankSize=13,this.planks=d/this.plankSize}onUpdate(t){super.onUpdate(t),this.isEnding||([...this.entities.flat()].forEach(e=>{const s=e.collision();s.collides&&(s.right&&(a.pos.x=e.pos.x+e.size.x,a.velocity.x=0),s.left&&(a.pos.x=e.pos.x-e.size.x,a.velocity.x=0),s.bottom&&(a.pos.y=e.pos.y+e.size.y,a.velocity.y=0),s.top&&(a.pos.y=e.pos.y-e.size.y,a.velocity.y=0))}),a.move(),a.pos.x=R(a.pos.x,0,h-x),a.pos.y=R(a.pos.y,0,d-x),a.velocity={x:R(a.velocity.x,-this.maxSpeed,this.maxSpeed),y:R(a.velocity.y,-this.maxSpeed,this.maxSpeed)}),a.velocity.x!=0||a.velocity.y!=0?a.drawWalking(t):a.drawStanding()}queryControls(t){E.isUp?a.velocity.y-=this.acceleration*t:E.isDown?a.velocity.y+=this.acceleration*t:a.velocity.y>0?a.velocity.y=Math.max(0,a.velocity.y-this.acceleration*t):a.velocity.y<0&&(a.velocity.y=Math.min(0,a.velocity.y+this.acceleration*t)),E.isLeft?(a.velocity.x-=this.acceleration*t,a.mirror=!0):E.isRight?(a.velocity.x+=this.acceleration*t,a.mirror=!1):a.velocity.x>0?a.velocity.x=Math.max(0,a.velocity.x-this.acceleration*t):a.velocity.x<0&&(a.velocity.x=Math.min(0,a.velocity.x+this.acceleration*t))}}class J extends A{constructor(t,e,s={}){const o={x:16,y:16};super(t,o),this.isNPC=!1,this.onTable=!1,this.holding=null,this.text=null,this.textTime=0,this.maxTextTime=1500,this.hide=!1,this.icon=e,this.mirror=!!s.mirror,this.isNPC=!!s.isNPC,this.onTable=!!s.onTable}update(t){if(!this.hide&&(this.onTable&&f.drawIcon(u.table,{...this.pos,y:this.pos.y+8}),f.drawIcon(this.icon,this.pos,!1,this.mirror),this.holding&&f.drawIcon(this.holding,this.pos,!1),this.textTime>0&&this.text)){this.textTime-=t||0;const e=this.textTime/this.maxTextTime;f.drawText({text:this.text,x:this.pos.x+8,y:this.pos.y-10+3*e,size:1,color:e>.66?n.black:e>.33?n.gray:n.light,textAlign:"center"})}}say(t,e=this.maxTextTime){this.text=t,this.textTime=e}}const Oe=[[u.plant,6,5],[u.plant,7,5],[u.plant,8,5],[u.chair,6,6],[u.chair,8,6,!0],[u.table,7,6],[u.table,7,7],[u.chair,8,7,!0],[u.chair,6,7],[u.camera,12,7,!0]],Be={npcNum:[1,5]};dt(["TY#"],[n.black,n.gray,n.light],1);class Ze extends mt{constructor(){super(...arguments),this.coffeeMaker=new J({x:48,y:192},u.coffeMachine,{mirror:!0,onTable:!0}),this.maxCofees=1,this.npcNum=0}onEnter(){this.text="Bring coffee",this.entities=Array.from({length:X},()=>[]);const t=p.getDifficulty();this.npcNum=j(Be.npcNum,t),super.onEnter(),a.setPos(30,30),a.holding=[],Oe.forEach(([e,s,o,r=!1])=>{this.entities[o][s]=new J({x:s*16,y:o*16},e,{mirror:r})}),this.coffeeMaker.hasCollided=!1,this.entities[this.coffeeMaker.pos.y/16][this.coffeeMaker.pos.x/16]=this.coffeeMaker;for(let e=0;e<this.npcNum;e++){let s=0,o=0,r=!1;for(;!r;){s=Math.floor((.15+.7*Math.random())*It),o=Math.floor((.15+.7*Math.random())*X),r=!0;for(let l=-1;l<=1&&r;l++)for(let g=-1;g<=1&&r;g++)(this.entities[o+l]&&this.entities[o+l][s+g]||a.pos.x==s+g&&a.pos.y==o+l)&&(r=!1)}this.entities[o][s]=new J({x:s*16,y:o*16},Q[e%Q.length],{isNPC:!0,mirror:!0})}}onLeave(){a.holding=[]}onUpdate(t){if(this.render(),this.entities.flat().forEach(e=>{e.update(t),e.isNPC&&e.hasCollided&&(!e.holding&&a.holding.length>0?(e.holding=u.coffee,e.say("TY#"),a.pop(),this.entities.flat().some(s=>s.isNPC&&!s.holding)||this.nice()):e.hasCollided=!1)}),this.coffeeMaker.hasCollided&&a.holding.length<this.maxCofees)for(;a.holding.length<this.npcNum;)a.hold(u.bigCoffee);super.onUpdate(t)}render(){for(let t=0;t<this.planks;t++)f.drawRect({x:-1,y:t*this.plankSize},{x:h+1,y:this.plankSize},n.light,n.white);f.drawRect({x:180,y:20},{x:130,y:d-40},n.light,n.white)}}const At=new Ze,L=70,Ct={goalSize:[4,2.5],trainSpeed:[130,200]};class He extends et{constructor(){super(...arguments),this.acceleration={x:.05,y:.05},this.jumpSpeed=6,this.trainSpeed=150,this.trainNum=4,this.maxFallSpeed=7,this.goalSize=3}onEnter(){super.onEnter(),this.text="Land safely";const t=p.getDifficulty();this.goalSize=j(Ct.goalSize,t),this.trainSpeed=j(Ct.trainSpeed,t),this.platforms=[];for(let e=0;e<this.trainNum;e++){const s=new O({x:e*(3*L+25),y:152},{x:3*L,y:L});s.setColor(n.gray,n.light),this.platforms.push(s)}this.deathColliders=[new A({x:0,y:d-10},{x:h,y:10})],this.goalCollider=new A({x:h-102,y:d-45},{x:x*this.goalSize,y:10}),a.pos={x:20,y:70}}onUpdate(t){f.drawRect({x:0,y:d-35},{x:h,y:35},n.gray,n.gray),this.goalCollider.render(n.white,n.black),super.onUpdate(t),!this.isStarting&&!this.isEnding&&(a.pos.x-=this.acceleration.x*t),this.platforms.forEach((e,s)=>{this.isStarting||(e.pos.x-=t*this.trainSpeed/1e3),f.drawIcon(u.wheel,Z(e.pos,16,L-8)),f.drawIcon(u.wheel,Z(e.pos,16*3,L-8)),f.drawIcon(u.wheel,Z(e.pos,3*L-16,L-8)),f.drawIcon(u.wheel,Z(e.pos,3*L-16*3,L-8)),lt({text:(this.trainNum-s).toString(),x:e.pos.x+15,y:e.pos.y+15,size:6,color:n.gray})})}renderCharacter(t){a.dead?a.drawDead():this.isEnding?a.drawStanding():a.drawWalking(t)}}const kt=new He;class Qt extends et{constructor(){super(...arguments),this.acceleration={x:.01,y:.05},this.buildingNum=10,this.jumpSpeed=7.5,this.maxJumps=1,this.difficultyRange={buildingNum:[8,12]}}onEnter(){super.onEnter(),this.text="Climb up";const t=p.getDifficulty();this.buildingNum=Math.round(j(this.difficultyRange.buildingNum,t)),this.maxY=Number.MAX_SAFE_INTEGER,this.minY=-Number.MAX_SAFE_INTEGER,a.pos={x:h/2,y:d/2+this.buildingNum*k-10},this.platforms=[];for(let s=0;s<this.buildingNum;s++)this.platforms.push(new z({x:(h-v)/2,y:k*s+d/2},1));const e=this.platforms[this.platforms.length-1];this.platforms.push(new O(Gt(e.pos,{x:0,y:k}),{x:v,y:10})),this.setDeathColliders()}setDeathColliders(){this.deathColliders=[new A({x:0,y:10+k*this.buildingNum+d/2},{x:h,y:d})]}onUpdate(t){this.yOffset=-a.pos.y+d/2,super.onUpdate(t)}drawExtras(){super.drawExtras();const t=this.deathColliders[0].pos.y-x;for(let e=0;e<6;e++)f.drawIcon(u.plant,{x:(h+v)/2+16*e,y:t}),f.drawIcon(u.plant,{x:(h-v)/2-16*(e+1),y:t});this.deathColliders[0].render(n.gray)}hasWon(){return!this.isEnding&&this.platforms[0].standsOn()}}const Ge=new Qt,zt={bushNum:[10,30],houseFallDuration:[5e3,2e3]};class Je extends mt{constructor(){super(...arguments),this.progress=0,this.houseFallDuration=5e3,this.windowOffset=.2,this.windowSize={x:.2,y:.1},this.goalCollider=null,this.fallingRight=!1}onEnter(){super.onEnter(),this.progress=0,this.text="Stay in",a.setPos(160,160);const t=p.getDifficulty(),e=j(zt.bushNum,t);this.houseFallDuration=j(zt.houseFallDuration,t),this.fallingRight=Math.random()>.5;const s=h*this.windowSize.x,o=d*this.windowSize.y*2,r=s*.6,l=o*.6,g=h*(1-this.windowOffset*2),m=d/2-d*this.windowSize.y,w=g+s*.1+(s-r)/2,y=m+(o-l)/2;this.goalCollider=new A({x:this.fallingRight?w:this.windowOffset*h+s*.2,y},{x:r,y:l}),this.entities=Array.from({length:X},()=>[]);for(let U=0;U<e;U++){let b=!1,P=0,S=0;for(;!b;){P=Math.floor(Math.random()*It),S=Math.floor(Math.random()*X),b=!this.entities[S][P];for(let D=-1;D<=1&&b;D++)for(let C=-1;C<=1&&b;C++)a.pos.x==(P+C)*16&&a.pos.y==(S+D)*16&&(b=!1)}this.entities[S][P]=new J({x:P*16,y:S*16},u.plant)}}onUpdate(t){var e;super.onUpdate(t),this.entities.flat().forEach(s=>s.update()),this.isStarting||(this.progress>=1?this.isEnding||((e=this.goalCollider)!=null&&e.collision().collides?this.nice():this.loseLife()):this.progress+=t/this.houseFallDuration,c.save(),this.fallingRight||(c.translate(h,0),c.scale(-1,1)),f.drawHouse(Math.pow(this.progress,3),this.windowSize,this.windowOffset),c.restore())}}const rt=new Je,Dt={changeChance:[.2,.2],actorSpeed:[.04,.08]};class Ie extends W{constructor(){super(...arguments),this.actorPos=0,this.actorSpeed=.07,this.actorState=3,this.changeChance=0,this.spotlightSpeed=2e-4,this.spotlightSize=.05,this.spotlightAngle=0}onEnter(){super.onEnter(),this.text="Spotlight",this.actorPos=h/2,this.spotlightAngle=0,this.actorState=Math.random()>.5?3:0;const t=p.getDifficulty();this.actorSpeed=j(Dt.actorSpeed,t),this.changeChance=j(Dt.changeChance,t)}onUpdate(t){super.onUpdate(t),f.drawRect({x:0,y:d-50},{x:h,y:50},n.light,n.light),f.drawIcon(u.camera,{x:16,y:d-50-16},!1,!0);for(let g=0;g<4;g++)f.drawIcon(u.plant,{x:h/2-16*g*2-24,y:d-50-16}),f.drawIcon(u.plant,{x:h/2+16*g*2+8,y:d-50-16});const e=this.actorState==1||this.actorState==0;f.drawIcon(u.npc1,{x:this.actorPos-8,y:d-50-10},!1,e),c.beginPath(),c.moveTo(h/2,80),c.globalAlpha=1,c.fillStyle=n.gray;const s={x:h/2+Math.sin((this.spotlightAngle+this.spotlightSize)*2*Math.PI)*d*2,y:80+d*2*Math.cos((this.spotlightAngle+this.spotlightSize)*2*Math.PI)},o={x:h/2+Math.sin((this.spotlightAngle-this.spotlightSize)*2*Math.PI)*d*2,y:80+d*2*Math.cos((this.spotlightAngle-this.spotlightSize)*2*Math.PI)};c.lineTo(s.x,s.y),c.lineTo(h,d),c.lineTo(h,0),c.lineTo(0,0),c.lineTo(0,d),c.lineTo(o.x,o.y),c.lineTo(h/2,80),c.fill(),f.drawLine(h/2,80,s.x,s.y,n.light),f.drawLine(h/2,80,o.x,o.y,n.light),f.drawIcon(u.base,{x:h/2-8,y:64}),f.drawIcon(u.wheel,{x:h/2-8,y:72});const r=h*.5*.9*Math.sin(2*Math.PI*this.spotlightAngle),l=this.actorPos-h/2-r;if(Math.abs(l)>40&&!this.isEnding&&this.loseLife(),!this.isEnding&&!this.isStarting){const g=this.actorState===0||this.actorState===3;t*Math.random()<this.changeChance*(g?1:2)&&(Math.random()>.5?this.actorState=Math.abs(this.actorState-1):this.actorState+=this.actorState===3?-1:1),this.actorPos+=t*this.actorSpeed*(this.actorState===0?-1:this.actorState===3?1:0)}this.actorPos>h*.8&&this.actorState===3?this.actorState=0:this.actorPos<h*.2&&this.actorState===0&&(this.actorState=3)}timeOver(){this.nice()}queryControls(t){E.isRight&&(this.spotlightAngle+=t*this.spotlightSpeed),E.isLeft&&(this.spotlightAngle-=t*this.spotlightSpeed),this.spotlightAngle=R(this.spotlightAngle,-.125,.125)}}const Lt=new Ie;let Rt=40;const Ft=-7,We=[3e3,2500];class Ye extends W{constructor(){super(...arguments),this.wheelPos=0,this.wheelOffset=0,this.wheelTurnTime=3e3,this.characterPos=Ft,this.isJumping=!1,this.jumpProgress=0,this.jumpTime=50,this.isFalling=!1,this.isDrifting=!1}onEnter(){super.onEnter(),this.timeLeft=5;const t=p.getDifficulty();this.wheelTurnTime=j(We,t),this.text="Stay dry",a.mirror=!0,this.characterPos=Ft,this.wheelPos=0,this.wheelOffset=Math.cos(this.wheelPos*2*Math.PI)/20,this.isFalling=!1,this.isDrifting=!1,this.setCharacterPos()}timeOver(){this.nice()}onUpdate(t){super.onUpdate(t),!this.isStarting&&!this.isEnding&&(this.wheelPos+=t/this.wheelTurnTime,this.wheelOffset=Math.cos(this.wheelPos*2*Math.PI)/20,this.wheelPos>=1&&(this.wheelPos-=1)),!this.isFalling&&!this.isDrifting&&(a.pos.y>d/2+20?(this.isFalling=!1,this.isDrifting=!0,T(()=>this.loseLife(),500)):a.pos.x<h/2-20?(this.isFalling=!0,this.isDrifting=!1,T(()=>this.loseLife(),500)):this.setCharacterPos()),this.isDrifting?(a.pos.y+=.04*t,a.pos.x-=.2*t):this.isFalling&&(a.pos.x-=.04*t,a.pos.y+=.2*t,a.pos.y>d*.6&&(this.isDrifting=!0)),this.isJumping&&(this.jumpProgress+=t/this.jumpTime,this.jumpProgress>1&&(this.isJumping=!1,this.jumpProgress=0)),f.drawBoatWheel(this.wheelPos+this.wheelOffset),a.mirror=!this.isDrifting,this.isDrifting?a.drawDrowning():a.draw(this.isJumping?u.jumping:u.base)}setCharacterPos(){let t=(this.wheelPos+this.wheelOffset-this.characterPos/8)%1;this.isJumping&&(t=(this.wheelPos+this.wheelOffset-(this.characterPos-1+this.jumpProgress)/8)%1);const e=t*2*Math.PI;a.setPos(h/2+Rt*1.5*Math.cos(e)-x/2,d/2+Rt*1.5*Math.sin(e)-x)}onUp(){!this.isStarting&&!this.isEnding&&!this.isJumping&&(this.characterPos++,this.isJumping=!0,this.jumpProgress=0)}}const Nt=new Ye;class $e extends Qt{constructor(){super(...arguments),this.acceleration={x:.3,y:.05},this.maxSpeed=3,this.ladders=[],this.fireAnimationProgress=0,this.fireAnimationTime=40,this.buildingNum=5,this.standingOnStairs=!1,this.difficultyRange={buildingNum:[4,9]}}onEnter(){super.onEnter(),this.text=" Escape ",this.ladders=[],this.standingOnStairs=!1,a.pos={x:h/2,y:d/2};for(let t=0;t<this.platforms.length-1;t++)this.ladders.push(15+ot(Math.random()*90/2)*2)}onUpdate(t){this.fireAnimationProgress+=t/this.fireAnimationTime,super.onUpdate(t)}hasWon(){return this.platforms[this.platforms.length-1].standsOn()}drawExtras(){super.drawExtras();const{x:t,y:e}=this.platforms[0].pos,s=Math.round(this.fireAnimationProgress/3)%3;for(let o=0;o<this.platforms.length-1;o++){const r=this.platforms[o];f.drawIcon(s>=1?u.fire1:u.fire2,{x:t-4,y:r.pos.y+10*Math.cos(o+1)},!1,s%2===0),f.drawIcon(s>=1?u.fire1:u.fire2,{x:t+v-4,y:r.pos.y+20*Math.cos(o)},!1,s%2===0)}this.platforms[this.platforms.length-1].render(n.white,n.black),this.standingOnStairs=!1,this.ladders.forEach((o,r)=>{const l=ot(a.pos.x)===ot(t+o-5)&&a.pos.y<e+r*k&&a.pos.y>e+(r-1)*k;this.standingOnStairs||(this.standingOnStairs=l);const g=l?n.black:n.gray;c.save(),c.translate(t+o,e+r*k),[0,10].forEach(m=>f.drawRect({x:m,y:0},{x:2,y:k},g,g));for(let m=0;m<6;m++)f.drawRect({x:0,y:6+7*m},{x:10,y:2},g,g);c.restore()})}onDown(){this.standingOnStairs&&(a.velocity.y=2,a.velocity.x=0,a.pos.y+=15)}}const Ve=new $e;class _e extends mt{constructor(){super(...arguments),this.trash=[]}onEnter(){super.onEnter();const t=p.getDifficulty(),e=j([.8,1.5],t);a.setPos(100,100),this.text="Clean up",this.trash=[];const s={x:Math.random()*h/2+h/4,y:Math.random()*d/2+d/4};for(let o=0;o<150;o++){const r=Math.random()*Math.PI*2,l=e*Math.random()*d/6,g=s.x+l*Math.cos(r),m=s.y+l*Math.sin(r);this.trash.push(new J({x:g,y:m},o%2==0?u.fire1:u.fire2))}}onUpdate(t){for(let e=0;e<this.planks;e++)f.drawRect({x:-1,y:e*this.plankSize},{x:h+1,y:this.plankSize},n.light,n.white);this.trash.forEach((e,s)=>{c.save(),c.translate(e.pos.x+e.size.x/2,e.pos.y+e.size.y/2),c.rotate((s%2?1:-1)*Math.PI/2),c.translate(-(e.pos.x+e.size.x/2),-(e.pos.y+e.size.y/2)),e.update(),c.restore(),e.collision().collides&&(e.hide=!0)}),super.onUpdate(t),a.draw(u.broom),!this.isEnding&&this.trash.every(e=>e.hide)&&this.nice()}}const qe=new _e;class Qe extends W{constructor(){super(...arguments),this.progress=0,this.jumpProgress=0,this.isFalling=!1,this.buildings=[-130/2,h-v/2].map(t=>new z({x:t,y:d-k*2-50},2))}onEnter(){super.onEnter(),this.maxTime=5,this.timeLeft=5,this.text="DON'T MOVE",this.progress=0,this.jumpProgress=0,this.isFalling=!1}onUpdate(t){super.onUpdate(t);let e=this.progress*.98+.02*Math.cos(this.progress*2*Math.PI*4);f.drawRect({x:0,y:d-60},{x:h,y:60},n.gray,n.gray),this.buildings.forEach(l=>l.update());const s=Math.sin(this.progress*2*Math.PI*4),o=Math.floor(j([v/2,h-v/2],e));let r;for(r=0;r<7;r++)f.drawIcon(Q[r%3],{x:o-s*r+(this.isFalling?5*this.jumpProgress*(r%2?1:-1)*r:0),y:d-65-r*14*(1-(this.isFalling?this.jumpProgress*this.jumpProgress:0))});this.progress<1&&!this.isFalling&&a.setPos(o-s*r,d-65-r*14),!this.isStarting&&!this.isEnding&&!this.isFalling&&(this.progress<1?this.progress+=t/((this.maxTime-1)*1e3):a.setPos(o-s*r+30*this.jumpProgress,d-65-r*14-30*Math.sin(this.jumpProgress*Math.PI*.98)),this.progress>=1&&this.jumpProgress<1&&(this.jumpProgress=Math.min(1,this.jumpProgress+t/300)),(E.isUp||E.isDown||E.isLeft||E.isRight)&&!this.isFalling&&(console.log("fall"),this.isFalling=!0,this.jumpProgress=0,T(()=>{this.loseLife()},500))),this.isFalling&&this.jumpProgress<1&&(this.jumpProgress=Math.min(1,this.jumpProgress+t/200),a.setPos(o-s*r,d-65-r*14*(1-this.jumpProgress))),a.drawStanding()}timeOver(){this.nice()}}const Xe=new Qe,Ot=[{name:"Assistant Dave",intro:"If you want to make it big in Hollywood kid, you better do as I say!",final:"Is that all you got?",outro:"I guess you're not totally worthless!",gameover:"Stop wasting my time kid!"},{name:"Director Leni",intro:"Just do what one tells you, and stay out of my way.",final:"Hurry, I have not the whole day.",outro:"Obedient and disciplined. You'll get far, child.",gameover:"Is there some reason my coffee isn't here?"},{name:"Director Alfred",intro:"Good evening. Are you ready to face your fears?",final:"It is time for your final act",outro:"Well done. I must admit, you handled the tension admirably.",gameover:"Was this worth the price of admission?"},{name:"Wally",intro:"I've been watching you grow. Show me what you got, ha ha.",final:"The wheel must keep spinning, ha ha!",outro:"Splendid. I can definitely use you, ha ha!",gameover:"This just won't do ha ha"}],Xt=[[At,vt,qe,kt],[Ge,vt,At,bt,rt],[Lt,Nt,rt,kt,bt,Xe],[Re,Lt,Ve,Ne,rt,Nt]],Ke=new Set(Xt.flat()),I=4;class ts{constructor(){this.highScore=0,this.boss=0,this.level=-1,this.maxLevel=0,this.lives=I,this.endless=!0,this.randomLevels=[],this.easyMode=!1,this.speedUp=!1,this.pause=!1,this.randomLevels=de(Array.from(Ke)),this.boss=St(),this.highScore=Me()}getBoss(){return Ot[Math.min(this.boss,Ot.length-1)]}getDifficulty(){const t=this.endless?this.level/26:(this.boss/3+this.level/12)/2;return Math.min(this.easyMode?t*.5:t,2)}start(){this.level=-1,this.level=-1,this.speedUp=!1,this.nextLevel()}nextLevel(){this.level++;let t;if(this.endless)t=this.randomLevels[this.level%this.randomLevels.length];else{const e=Xt[this.boss];t=e[this.level%e.length]}M.setState(t)}nextBoss(){if(this.boss==3){M.setState(gt);return}this.boss++,St()<this.boss&&qt(this.boss),this.level=-1,this.speedUp=!1,M.setState(pt)}restartLevel(){M.getState().onEnter&&M.getState().onEnter()}}const p=new ts,ht=["start  "];class es{constructor(){this.selectedButton=0,this.showWarning=!1,document.addEventListener("click",()=>this.showWarning=!0)}onEnter(){F.stop()}onLeave(){}onUpdate(t){["TERRIBLE","STUNTS"].forEach((e,s)=>[n.light,n.black].forEach((o,r)=>f.drawText({text:e,x:h/2-r,y:40+s*15-r,textAlign:"center",color:o,size:2}))),ht.forEach((e,s)=>{f.drawText({text:(s===this.selectedButton?"& ":"  ")+e,x:h/2,y:120+s*16,textAlign:"center",color:s===this.selectedButton?n.black:n.gray,size:1})}),this.showWarning&&[n.light,n.black].forEach((e,s)=>{f.drawText({text:"Use  Enter + WASD/Arrows  to play",x:h/2,y:100-s,textAlign:"center",color:e,size:1})}),c.save(),c.globalAlpha=.5,c.translate(.5,.5),c.rotate(-25),c.scale(8,8),f.drawIcon(u.jumping,{x:3,y:13}),c.restore(),f.drawText({text:"Press Enter to start",x:h/2,y:d-15,textAlign:"center",color:n.gray,size:1})}onUp(){this.selectedButton--,this.selectedButton<0&&(this.selectedButton=ht.length-1)}onDown(){this.selectedButton++,this.selectedButton>ht.length-1&&(this.selectedButton=0)}onConfirm(){this.selectedButton===0&&(p.endless=!0,p.level=-1,p.lives=I,M.setState(gt))}}const K=new es;class ss{constructor(){this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.isConfirm=!1,this.isEscape=!1,this.isKeyE=!1,this.keyMap=new Map,this.previousState={isUp:this.isUp,isDown:this.isDown,isRight:this.isRight,isLeft:this.isLeft,isConfirm:this.isConfirm,isEscape:this.isEscape,isKeyE:this.isKeyE},"keyboard"in navigator&&(this.keyboard=navigator.keyboard),document.addEventListener("keydown",t=>this.toggleKey(t,!0)),document.addEventListener("keyup",t=>this.toggleKey(t,!1)),this.inputDirection=new DOMPoint}queryController(){this.previousState.isUp=this.isUp,this.previousState.isDown=this.isDown,this.previousState.isConfirm=this.isConfirm,this.previousState.isEscape=this.isEscape,this.previousState.isKeyE=this.isKeyE;const t=this.keyMap.get("KeyA")||this.keyMap.get("KeyQ")||this.keyMap.get("ArrowLeft")?-1:0,e=this.keyMap.get("KeyD")||this.keyMap.get("ArrowRight")?1:0,s=this.keyMap.get("KeyW")||this.keyMap.get("KeyZ")||this.keyMap.get("ArrowUp")?-1:0,o=this.keyMap.get("KeyS")||this.keyMap.get("ArrowDown")?1:0;this.inputDirection.x=t+e||0,this.inputDirection.y=s+o||0,this.isUp=this.inputDirection.y<0,this.isDown=this.inputDirection.y>0,this.isLeft=this.inputDirection.x<0,this.isRight=this.inputDirection.x>0,this.isConfirm=!!this.keyMap.get("Enter")||!!this.keyMap.get("Space"),this.isEscape=!!this.keyMap.get("Escape"),this.isKeyE=!!this.keyMap.get("KeyE")}onUpdate(t){this.queryController(),this.isUp&&(this.previousState.isUp||typeof t.onUp=="function"&&t.onUp()),this.isDown&&(this.previousState.isDown||typeof t.onDown=="function"&&t.onDown()),this.isRight&&(this.previousState.isRight||typeof t.onRight=="function"&&t.onRight()),this.isLeft&&(this.previousState.isLeft||typeof t.onLeft=="function"&&t.onLeft()),this.isConfirm&&(this.previousState.isConfirm||typeof t.onConfirm=="function"&&t.onConfirm())}toggleKey(t,e){p.pause||this.keyMap.set(t.code,e),e||(t.key==="Escape"&&(M.getState()!=K&&M.setState(K),p.pause=!1),t.code==="KeyP"&&(p.pause=!p.pause))}}const E=new ss;document.querySelector('link[type="image/x-icon"]').href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🎞%3C/text%3E%3C/svg%3E";async function is(){await f.init(),he()}let Bt=0;function Kt(i){let t=i-Bt;if(t>=16){p.speedUp&&(t*=1.3),Bt=i,f.clear(),p.pause&&(t=0);const e=M.getState();E.onUpdate(e),e.onUpdate(t),e.postRender&&e.postRender(t),Ae(t),p.pause&&f.renderPause()}requestAnimationFrame(Kt)}is().then(()=>{oe(K),requestAnimationFrame(Kt)});
